<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:jdbc="http://www.springframework.org/schema/jdbc" 
	xmlns:tx="http://www.springframework.org/schema/tx"
	xmlns:jpa="http://www.springframework.org/schema/data/jpa"
	xmlns:task="http://www.springframework.org/schema/task"
	xmlns:mvc="http://www.springframework.org/schema/mvc"
	xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/jdbc
        http://www.springframework.org/schema/jdbc/spring-jdbc.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/data/jpa
        http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
        http://www.springframework.org/schema/task
        http://www.springframework.org/schema/task/spring-task.xsd
		http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd        
        ">

	<!-- Defaults to db/migration -->
	<bean id="flyway" class="org.flywaydb.core.Flyway" init-method="migrate">
	    <property name="dataSource" ref="dataSource"/>
	</bean>


	<!-- the name 'entityManagerFactory' is mandatory to made it available to spring-data repos -->
	<bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean" depends-on="flyway">
		<property name="dataSource" ref="dataSource" />
		<property name="packagesToScan" value="com.danidemi.europrice.db" />
		<property name="jpaVendorAdapter">
			<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter" />
		</property>
		<property name="jpaProperties">
			<props>
				<!-- http://docs.jboss.org/hibernate/core/3.3/reference/en/html/session-configuration.html#configuration-optional -->
				<!-- validate | update | create | create-drop -->
				<prop key="hibernate.hbm2ddl.auto">validate</prop>
				<prop key="hibernate.dialect">org.hibernate.dialect.HSQLDialect</prop>
			</props>
		</property>
	</bean>
	
	<jpa:repositories base-package="com.danidemi.europrice.db"/>

	<bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
		<property name="entityManagerFactory" ref="entityManagerFactory" />
	</bean>
	<tx:annotation-driven />
	
	<context:annotation-config/>
	<context:component-scan base-package="com.danidemi.europrice.web.controller"/>
	<mvc:annotation-driven />
		

	<bean id="persistenceExceptionTranslationPostProcessor"
		class="org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor" />
		
	<bean id="repo"
		class="com.danidemi.europrice.db.Repository" >
	</bean>

	<bean id="task" class="com.danidemi.europrice.tasks.ScreenScrapingTask">
		<property name="productItemRepository" ref="productItemRepository" />
		<property name="shopRepository" ref="shopRepository" />
		<property name="scrapers">
			<list>
				<bean class="com.danidemi.europrice.tasks.scrapers.OSelectionScraper" />
			</list>
		</property>
	</bean>
	
	<!-- Jetty -->
	<!--  
	<bean id="jetty" class="org.eclipse.jetty.server.Server" init-method="start" destroy-method="stop">
		<property name="connectors">
			<list>
				<bean class="org.eclipse.jetty.server.nio.SelectChannelConnector">
					<property name="port" value="80" />
				</bean>
			</list>
		</property>
		<property name="handler">
      		<bean class="org.eclipse.jetty.server.handler.HandlerCollection">
        		<property name="handlers">
          			<list>
          				<bean class="org.eclipse.jetty.server.handler.ContextHandler">
          					<property name="errorHandler"><null/></property>
          					<property name="contextPath" value="/" />
          					<property name=""></property>
          				</bean>
          				
       
             			<bean class="org.eclipse.jetty.server.handler.DefaultHandler">
             				<property name="showContexts" value="true" />
             			</bean>
          			</list>
        		</property>
      		</bean>
		</property>
	</bean>
	-->
	<!--  
	
  	<bean id="contexts" class="org.eclipse.jetty.server.handler.ContextHandlerCollection"/>
  	<bean id="jetty" class="org.mortbay.jetty.spring.Server" init-method="start" destroy-method="stop">
	    <property name="jettyThreadPool">  
	      <bean id="ThreadPool" class="org.eclipse.jetty.util.thread.QueuedThreadPool">
	        <property name="minThreads" value="10"/>
	        <property name="maxThreads" value="50"/>
	      </bean>
	    </property>
	    <property name="connectors">
	      <list>
	        <bean id="connector" class="org.eclipse.jetty.server.nio.SelectChannelConnector">
	          <property name="port" value="80"/>
	        </bean>
	      </list>
	    </property>
    	<property name="handler">
      		<bean id="handlers" class="org.eclipse.jetty.server.handler.HandlerCollection">
        		<property name="handlers">
          			<list>
	     				<ref bean="contexts"/>
             			<bean id="defaultHandler" class="org.eclipse.jetty.server.handler.DefaultHandler"/>
          			</list>
        		</property>
      		</bean>
    	</property>
    	<property name="beans">
      		<list>
        		<bean id="ContextDeployer" class="org.mortbay.jetty.spring.ContextDeployer">
          			<property name="contexts" ref="contexts"/>
          			<property name="contextsDir" value="contexts"/>
          			<property name="scanInterval" value="5"/>
        		</bean>
        <bean id="WebAppDeployer" class="org.eclipse.jetty.deploy.WebAppDeployer">
          <property name="contexts" ref="contexts"/>
          <property name="webAppDir" value="webapps"/>
          <property name="extract" value="true"/>
          <property name="defaultsDescriptor" value="etc/webdefault.xml"/>
        </bean>
 
        <bean class="org.eclipse.jetty.security.HashLoginService">
          <property name="name" value="Test Realm"/>
          <property name="config" value="etc/realm.properties"/>
          <property name="refreshInterval" value="0"/>
        </bean>
 
      </list>
    </property>
 
  </bean>
-->
<!--  
	<bean name="dispatcherServler" class="org.springframework.web.servlet.DispatcherServlet">

	</bean>

	<bean name="jetty" class="com.danidemi.europrice.jetty.EmbeddedJetty" init-method="start">
	</bean>
-->

	<bean name="js" class="com.danidemi.europrice.jetty.JettyServer" init-method="start" destroy-method="stop">
		<property name="jettyPort" value="8080" />
		<property name="jettyWebAppContext">
			<bean class="com.danidemi.europrice.jetty.JettyWebAppContextFactory" />
		</property>
	</bean>
	
	<bean name="dispatcherServler" class="org.springframework.web.servlet.DispatcherServlet">

	</bean>	

	<task:scheduler id="myScheduler" pool-size="10"/>
	
	<beans profile="embedded">
	
		<jdbc:embedded-database id="dataSource" />
		
	</beans>
	<beans profile="local">
	
		<task:scheduled-tasks scheduler="myScheduler">
		    <task:scheduled ref="task" method="run" trigger="trigger"/>
		</task:scheduled-tasks>
		<bean name="trigger" class="com.danidemi.jlubricant.spring.context.trigger.NeverTrigger" />
		
				
		<bean name="dataSource" class="org.apache.commons.dbcp.BasicDataSource">
			<property name="driverClassName" value="" />
			<property name="url" value="jdbc:hsqldb:hsql://localhost/europrices" />
			<property name="username" value="SA" />
			<property name="password" value="" />
		</bean>
	</beans>	

</beans>